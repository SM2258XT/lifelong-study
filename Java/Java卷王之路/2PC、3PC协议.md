---
title: 2PC、3PC协议
updated: 2023-03-09T09:00:35
created: 2022-11-12T10:19:26
---

**2PC：两阶段提交协议**

Mysql、Oracle支持
1.  **准备阶段**
事务管理器TM给每个参与者发送Prepare消息，每个参与者在本地执行事务，并写本地undo/redolog日志，但是事务还没提交
1.  **提交阶段**
1）TM给每个参与者发送Commit消息。若出错：TM收到任意参与者失败或超时消息时，直接给每个参与者发送Rollback消息

2）释放锁资源，无论结果如何

**缺点**
1.  **同步阻塞**（最大问题）
所有的事务参与者都处理阻塞状态，等待直至其他参与者都响应或超时。而这段时间无法进行其他操作，极大地限制了分布式系统性能。
1.  **容错不完善**
    1.  TM导致整体故障
TM挂了，所有都没法运转。而且万一是协调阶段TM挂了，则参与者释放不了锁
1.  任意节点导致整体故障
1.  **网络问题导致数据不一致**
TM发送Commit时只有部分收到

**3PC：三阶段提交协议**
1.  CanCommit
TM向所有参与者询问是否可以执行提交操作，参与者返回Yes/No
1.  PreCommit
TM得到响应后，若出错则发起事务中断，否则执行事务预提交
1.  发送PreCommit，进入准备阶段
2.  参与者收到PreCommit，执行事务，记录undo/redolog
3.  反馈结果给TM。出错则为No或超时
出错中断事务：可能是TM发现出错而主动发起abort中断，也可能是参与者被动接收abort或者等待TM超时而中断
1.  doCommit
    1.  发送doCommit
    2.  真正的提交
    3.  释放锁、反馈结果等

**日志复习**
undolog：记录修改前数据，用于回滚
redolog：记录修改后数据，用于提交数据写文件
