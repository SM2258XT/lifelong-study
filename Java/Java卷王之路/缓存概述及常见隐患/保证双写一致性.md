---
title: 保证双写一致性
updated: 2022-11-12T08:25:44
created: 2022-10-29T07:35:27
---

保证双写一致性
2022年10月29日
7:35

**理想情况下的双写模式CAP（Cache Aside Pattern）**
读取时：先读前面缓存，没有则读后面数据库，取出后顺便放回前面缓存
**更新时：**先更后面数据库，在**删除**前面缓存（可能缓存删除失败）
注意：直接删除而不是更新缓存

稍微复杂点的场景下，缓存不是数据库中直接取出的信息，可能是另外两个表的数据运算结果等，也可能这个缓存并不会被频繁访问不需要缓存（update多，select少）

例如：

一个缓存涉及的表的字段，在 1 分钟内就修改了 20 次，或者是 100 次，那么缓存更新 20 次、100 次；但是这个缓存在 1 分钟内只被读取了 1 次，有大量的冷数据。实际上，如果你只是删除缓存的话，那么在 1 分钟内，这个缓存不过就重新计算一次而已，开销大幅度降低。用到缓存才去算缓存。

**实际缓存删除失败**
更新完数据库，删除缓存时，如果删除失败了，这时就出现了不一致
解决：
1.  先后顺序换一下，先删缓存再更数据库。
2.  **延时双删**。也是先删缓存再更数据库，过段时间之后再删一次缓存。

**极端情况下的一致性解决：读写串行化**
如果不考虑操作失败的话，那么串行解决一切问题，但是吞吐量会降低N倍！所以如果缓存和数据库一致性问题，可以适当容忍一点的话，尽量不要用这个方案！

以上总结：1）延时双删 2）串行化
