---
title: Redis三种集群
updated: 2022-10-14T16:34:01
created: 2022-10-14T08:48:00
---

Redis三种集群
<http://www.redis.cn/topics/cluster-tutorial.html>
2022年10月14日
8:48

**主从集群：手动设置、有中心、全量存储**
主节点可读可写， 从节点只读（并且从主节点同步数据）
主要命令：
slaveof \[ip\] \[port\] \# 让本机作为ip:port的slaver。临时有效断电丢失
replicaof \[masterip\] \[masterport\] \# 主要是写在配置文件中

缺点：master下线后，集群只读而不可写

**哨兵（Sentinel）：有中心、全量存储**
当主从模式master下线后，会在slavers中选一个来作为新的master
为了解决主从集群master下线后，只读不写的问题。
- 作用：监控、通知、故障迁移、统一管理
- 哨兵原理（Raft算法）：
哨兵使用的算法核心是 Raft 算法，主要用途就是用于分布式系统，系统容错，以及Leader选举，每个哨兵都需要定期的执行以下任务

每个哨兵会自动发现其他 哨兵和从服务器，它以每秒钟一次的频率向它所知的主服务器、从服务器以及其他 哨兵实例发送一个 PING 命令。

如果一个实例(instance)距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 那么这个实例会被 哨兵标记为主观下线。 有效回复可以是： +PONG 、 -LOADING 或者 -MASTERDOWN 。

如果一个主服务器被标记为主观下线， 那么正在监视这个主服务器的所有哨兵要以每秒一次的频率确认主服务器的确进入了主观下线状态。

如果一个主服务器被标记为主观下线， 并且有足够数量的哨兵(至少要达到配置文件指定的数量)在指定的时间范围内同意这一判断， 那么这个主服务器被标记为客观下线。

在一般情况下， 每个哨兵会以每 10 秒一次的频率向它已知的所有主服务器和从服务器发送 INFO 命令。 当一个主服务器被哨兵标记为客观下线时，哨兵向下线主服务器的所有从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。

当没有足够数量的哨兵同意主服务器已经下线， 主服务器的客观下线状态就会被移除。 当主服务器重新向哨兵的 PING 命令返回有效回复时， 主服务器的主管下线状态就会被移除。
注意：哨兵是单独的一个程序哦，而不是其中的redis-server

**分片集群（Cluster）：去中心、分片存储、 推荐至少3主3从**
引入哈希槽的概念（没有使用一致性hash）：CRC16(KEY) % 16384
Redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽。集群的每个节点负责一部分hash槽（而不是一个hash槽！）
比如当前集群有3个节点，那么：节点 A（0 - 5500号哈希槽）、节点 B （5501 - 11000）、C（11001 - 16384）
当某块节点（主+从）全部失效时，整个集群会因为缺少该块的hash槽而导致不可用！（而不会重新移动hash因为都已经丢失数据了，宕机节点的数据短时间内找不回来没法移动）
分片集群可以额外开启，但不依赖哨兵。因为Cluster本身就具有选举特性
![](C:\Users\82609\AppData\Local\Temp\Java\pandoc/media/image1.png)![](C:\Users\82609\AppData\Local\Temp\Java\pandoc/media/image2.png)
<https://www.bilibili.com/video/BV1F44y1C7N8>
