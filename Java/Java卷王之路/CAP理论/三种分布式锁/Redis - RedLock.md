---
title: Redis - RedLock
updated: 2024-09-13T12:01:27
created: 2022-10-25T16:28:58
---

**核心思想：**过半机制。半数节点以上获取锁成功，才判定分布式锁获取成功。
要求：
1.  必须只能是独立节点集群，而不能是主从复制或Cluster
2.  每个节点时钟必须同步
缺点：
效率低，要求集群机器的时钟同步

**获取锁的步骤：**
1.  获取当前时间戳
2.  在N个实例中，不再使用SET NX，而是使用 hset col k v 【K为固定值，**V为计数器值**】来获取锁。
这里还可以升级，用资源访问Token；或hset uuid
1.  时间和条件控制
最终分布式锁的获取成功判定，必须满足以下三个条件：
1.  每个节点不得超过最大访问时间
每个节点交互过程中，时间必须小于一个固定的网络超时时间。比如锁过期为10s，则请求每个节点在100-1000ms之间，超时则失败，继续下一个节点尝试获取锁
1.  总询问时间
总询问时间必须小于TTL过期时间。所有节点获取锁操作都尝试过一遍后，得出的总询问时间。
1.  半数+
至少要有半数及以上节点获取成功。否则将发起释放锁流程。

锁的最终逻辑有效时间 = 过期时间 - 总询问时间
1.  失败或过期释放
不仅是过期会释放锁，获取锁失败也会发起释放锁的请求！这个释放锁是指每个节点都释放一次。
1.  手动释放
将每个节点的 【V：计数器值】- 1，若归零则删除key；未归零则不释放（因为是可重入的）

这里直接向所有节点统统发出删除指令，而不进行任何判断，是因为Key只有自己节点知道，不怕误删到别的数据。
1.  过期自动释放
    1.  超过Expire，则每个节点都会自动释放，是一个兜底的策略。
![](C:\Users\82609\AppData\Local\Temp\Java\pandoc/media/image1.png)
