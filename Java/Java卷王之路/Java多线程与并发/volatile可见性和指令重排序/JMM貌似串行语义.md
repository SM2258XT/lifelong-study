---
title: JMM貌似串行语义
updated: 2022-09-16T10:56:09
created: 2022-09-06T09:34:00
---

JMM貌似串行语义
2022年9月6日
9:34

JMM(Java内存模型Java Memory Model，简称JMM)本身是一种**抽象的概念，并不真实存在**它仅仅描述的是一组约定或规范，屏蔽掉各种硬件和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果。通过这组规范定义了程序中(尤其是多线程)各个变量的读写访问方式并决定一个线程对共享变量的写入何时以及如何变成对另一个线程可见，关键技术点都是围绕多线程的原子性、可见性和有序性展开的。

Java中，代码编译成CPU指令后，最理想情况是<u>这些代码就已经被并行优化不会出错</u>。（但事实上很困难，几乎不能实现）
达不到理想状况，因此JMM底线降低了一点，提出了貌似串行语义
- **貌似串行语义（As-if-serial Semantics）：**单线程的结果不会改变，多线程的执行结果**可能受到影响**。
JIT编译器、处理器、存储子系统是按照一定的规则对指令和内存操作结果进行重排序，给单线程程序造成一种假象，好像程序是按照源码的顺序执行的。这种假象称为貌似串行语义。

如果不存在数据依赖关系，则可能进行数据重排序。

存在控制依赖关系，则可能进行数据重排序。
因此要保证多线程安全，需要手动去保证，也就是使用锁来实现/控制多线程代码，然后对于每个线程再由JMM安全执行。

重排序：A核心上线程所执行的操作，在B线程上看来可能是乱序的，和代码里指定的顺序不一样。
也就是说，多核处理器环境下，线程的执行顺序是没有保障的。
1.  编译器可能会优化改变两个操作的先后顺序。
2.  处理器可能不会按照目标代码顺序执行。

重排序分类：
1.  指令重排序：由JIT编译器，处理器引起的，编译器优化了执行顺序。
2.  存储子系统创排序：由高速缓存、写缓冲器引起的，感知顺序与执行顺序不一致。

